<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пульт Управления</title>
    <style>@keyframes pulse{0%{transform:scale(1);opacity:.8}50%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:.8}}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;background-color:#121212;color:#e0e0e0;margin:0;text-align:center;overflow-y:auto}.main-content{padding:20px 0}.container{display:flex;justify-content:space-around;width:95%}.player{width:45%}input[type=text]{background-color:#333;color:#fff;border:none;font-size:5vw;width:100%;text-align:center;margin-bottom:5px;padding:10px;border-radius:8px;transition:background-color .3s ease}.score{font-size:18vw;font-weight:700;line-height:1;cursor:pointer;user-select:none;color:#4CAF50}.sets{font-size:5vw;font-weight:700;margin-top:15px;color:#FFC107}.serve-indicator{font-size:4vw;height:5vw;margin-top:15px;user-select:none;color:#f4c724;visibility:hidden}.serve-active{visibility:visible}button{background-color:#555;color:#fff;border:none;padding:10px 20px;font-size:1.2vw;cursor:pointer;margin:5px;border-radius:8px}button:hover{background-color:#777}.divider{width:1px;background-color:#555}.controls-footer{margin-top:20px;display:flex;gap:10px;align-items:center;width:100%;justify-content:center}.server-select-container{margin-bottom:15px}.server-select-container h3{font-size:1.5vw;margin:5px 0}.server-select-container button{padding:8px 15px;font-size:1vw;color:#e0e0e0;border:1px solid #777}.server-select-container button.selected{background-color:#4CAF50;box-shadow:0 0 10px #4CAF50;border-color:#4CAF50}.player-select{width:100%;padding:8px;background-color:#333;color:white;border-radius:5px;border:1px solid #555;font-size:1.2vw;margin-bottom:20px}.db-management{border:1px solid #444;border-radius:10px;padding:15px;margin-bottom:20px}.db-management h3{margin:0 0 10px 0;font-size:1.5vw}.db-management input{font-size:1.2vw;width:200px;padding:8px}.db-management button{font-size:1.2vw}.history-container{margin-top:25px;border-top:1px solid #444;padding-top:15px;width:80%}.history-container h3{font-size:1.5vw}.history-list{display:flex;flex-direction:column;align-items:center;gap:8px;font-size:1.5vw;font-weight:700}</style>
</head>
<body>
    <div class="main-content">
        <div class="db-management"><h3>База игроков</h3><input type="text" id="newPlayerName" placeholder="Имя Фамилия нового игрока"><button onclick="addPlayer()">Добавить</button><button onclick="clearPlayers()">Очистить список</button></div>
        <div class="server-select-container"><h3>Кто подает первым?</h3><button onclick="setInitialServer(1)" id="serverBtn1">Игрок 1</button><button onclick="setInitialServer(2)" id="serverBtn2">Игрок 2</button></div>
        <div class="container"><div class="player" id="player1"><input type="text" placeholder="Игрок 1" id="name1"><select class="player-select" id="player1-select" onchange="selectPlayer(1, this.value)" onclick="event.stopPropagation()"></select><div class="score" onclick="addPoint(1)">0</div><div class="sets">Сеты: 0</div><div class="serve-indicator" id="serve1">●</div><button onclick="removePoint(1)">-1 Очко</button><button onclick="addSet(1)">+1 Сет</button><button onclick="removeSet(1)">-1 Сет</button></div><div class="divider"></div><div class="player" id="player2"><input type="text" placeholder="Игрок 2" id="name2"><select class="player-select" id="player2-select" onchange="selectPlayer(2, this.value)" onclick="event.stopPropagation()"></select><div class="score" onclick="addPoint(2)">0</div><div class="sets">Сеты: 0</div><div class="serve-indicator" id="serve2">●</div><button onclick="removePoint(2)">-1 Очко</button><button onclick="addSet(2)">+1 Сет</button><button onclick="removeSet(2)">-1 Сет</button></div></div>
        <div class="controls-footer"><button onclick="resetScore()">Сбросить счет</button><button onclick="resetGame()">Новая игра</button><button onclick="swapColors()">Поменять цвета</button></div>
        <div class="history-container"><h3>История партий</h3><div id="historyList" class="history-list"></div></div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
   <script>
    (function() { const p = "886622"; const e = prompt("Введите пароль для доступа к пульту:", ""); if (e !== p) { alert("Неверный пароль."); document.body.innerHTML = '<h1 style="color:red;text-align:center;margin-top:50px">ДОСТУП ЗАПРЕЩЕН</h1>'; throw new Error("Access Denied") } })();
    
    const firebaseConfig = {
        apiKey: "AIzaSyDTxZWC9Txxg4hHkpMkKOoq6eyZ-QHlCt4",
        authDomain: "gtr-cup-court-2.firebaseapp.com",
        projectId: "gtr-cup-court-2",
        storageBucket: "gtr-cup-court-2.firebasestorage.app",
        messagingSenderId: "5588116973",
        appId: "1:5588116973:web:f0c9ef08514426b2e633e4"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);
    const tableId = urlParams.get('table') || '1';
    const firebasePath = `gameState_Table${tableId}`;
    const stateRef = database.ref(firebasePath);

    let gameState = null;

    const scoreEls = [document.querySelector("#player1 .score"), document.querySelector("#player2 .score")];
    const setEls = [document.querySelector("#player1 .sets"), document.querySelector("#player2 .sets")];
    const serveEls = [document.getElementById("serve1"), document.getElementById("serve2")];
    const nameInputs = [document.getElementById("name1"), document.getElementById("name2")];
    const serverBtns = [document.getElementById("serverBtn1"), document.getElementById("serverBtn2")];
    const playerSelects = [document.getElementById("player1-select"), document.getElementById("player2-select")];
    const newPlayerNameInput = document.getElementById("newPlayerName");
    const historyListEl = document.getElementById("historyList");

    let playerDB = [];

    function loadPlayers() {
        const storedPlayers = localStorage.getItem("playerDatabase");
        playerDB = storedPlayers ? JSON.parse(storedPlayers) : [];
        playerSelects.forEach(select => {
            select.innerHTML = '<option value="">-- Выбрать игрока --</option>';
            playerDB.forEach(player => {
                const option = document.createElement("option");
                option.value = player;
                option.textContent = player;
                select.appendChild(option);
            });
        });
    }

    function savePlayers() {
        localStorage.setItem("playerDatabase", JSON.stringify(playerDB));
    }

    function addPlayer() {
        const newName = newPlayerNameInput.value.trim();
        if (newName && !playerDB.includes(newName)) {
            playerDB.push(newName);
            playerDB.sort();
            savePlayers();
            loadPlayers();
            newPlayerNameInput.value = "";
        }
    }

    function clearPlayers() {
        if (confirm("Вы уверены?")) {
            playerDB = [];
            savePlayers();
            loadPlayers();
        }
    }

    function selectPlayer(playerIndex, playerName) {
        if (playerName) {
            nameInputs[playerIndex - 1].value = playerName;
            nameInputs[playerIndex - 1].dispatchEvent(new Event("input"));
        }
    }

    nameInputs[0].oninput = () => {
        if (!gameState) return;
        gameState.names[0] = nameInputs[0].value || "Игрок 1";
        serverBtns[0].textContent = gameState.names[0];
        saveState();
    };
    nameInputs[1].oninput = () => {
        if (!gameState) return;
        gameState.names[1] = nameInputs[1].value || "Игрок 2";
        serverBtns[1].textContent = gameState.names[1];
        saveState();
    };

    function saveState() {
        if (gameState) stateRef.set(gameState);
    }

    // --- ГЛАВНАЯ ЛОГИКА ОБНОВЛЕНИЯ ПОДАЧИ ---
    function calculateAndUpdateServer() {
        if (!gameState) return;
        const [s1, s2] = gameState.scores;
        const totalPoints = s1 + s2;
        const opponent = gameState.initialServer === 1 ? 2 : 1;

        if (s1 >= 10 && s2 >= 10) {
            const pointsIntoDeuce = totalPoints - 20;
            gameState.server = (pointsIntoDeuce % 2 === 0) ? gameState.initialServer : opponent;
        } else {
            const serveChanges = Math.floor(totalPoints / 2);
            gameState.server = (serveChanges % 2 === 0) ? gameState.initialServer : opponent;
        }
    }

    function setInitialServer(player) {
        if (!gameState) return;
        gameState.initialServer = player;
        gameState.server = player; // Сразу устанавливаем и текущего подающего
        saveState();
    }

    function addPoint(player) {
        if (!gameState) return;
        gameState.scores[player - 1]++;
        checkGameEnd(); // Сначала проверяем, не закончился ли сет
        calculateAndUpdateServer(); // Затем обновляем подающего на основе нового счета
        saveState();
    }

    function removePoint(player) {
        if (!gameState || gameState.scores[player - 1] <= 0) return;
        gameState.scores[player - 1]--;
        calculateAndUpdateServer(); // Пересчитываем подающего
        saveState();
    }

    function addSet(player) {
        if (!gameState) return;
        gameState.sets[player - 1]++;
        saveState();
    }

    function removeSet(player) {
        if (!gameState || gameState.sets[player - 1] <= 0) return;
        gameState.sets[player - 1]--;
        saveState();
    }

    function swapColors() {
        if (!gameState) return;
        gameState.colorAssignment = gameState.colorAssignment === "swapped" ? "default" : "swapped";
        saveState();
    }
    
    function checkGameEnd() {
        if (!gameState) return;
        const [s1, s2] = gameState.scores;

        if ((s1 >= 11 && s1 - s2 >= 2) || (s2 >= 11 && s2 - s1 >= 2)) {
            gameState.sets[s1 > s2 ? 0 : 1]++;
            gameState.gameHistory.push({ p1: s1, p2: s2 });
            gameState.scores = [0, 0];
            // В следующем сете подача переходит к другому игроку
            gameState.initialServer = gameState.initialServer === 1 ? 2 : 1;
            // Сразу устанавливаем правильного подающего для начала нового сета
            gameState.server = gameState.initialServer; 
        }
    }
    
    function updateDisplay(data) {
        const defaults = { scores: [0, 0], sets: [0, 0], server: 1, initialServer: 1, names: ["Игрок 1", "Игрок 2"], gameHistory: [], colorAssignment: "default" };
        gameState = { ...defaults, ...data };

        scoreEls[0].textContent = gameState.scores[0];
        scoreEls[1].textContent = gameState.scores[1];
        setEls[0].textContent = "Сеты: " + gameState.sets[0];
        setEls[1].textContent = "Сеты: " + gameState.sets[1];
        nameInputs[0].value = gameState.names[0];
        nameInputs[1].value = gameState.names[1];

        serverBtns[0].textContent = gameState.names[0];
        serverBtns[1].textContent = gameState.names[1];
        serverBtns[0].classList.toggle("selected", gameState.initialServer === 1);
        serverBtns[1].classList.toggle("selected", gameState.initialServer === 2);

        serveEls[0].classList.toggle("serve-active", gameState.server === 1);
        serveEls[1].classList.toggle("serve-active", gameState.server === 2);

        const color1 = "#000000";
        const color2 = "#20B2AA";
        const fontColor1 = "#FFFFFF";
        const fontColor2 = "#000000";

        if (gameState.colorAssignment === "swapped") {
            nameInputs[0].style.backgroundColor = color2;
            nameInputs[0].style.color = fontColor2;
            nameInputs[1].style.backgroundColor = color1;
            nameInputs[1].style.color = fontColor1;
        } else {
            nameInputs[0].style.backgroundColor = color1;
            nameInputs[0].style.color = fontColor1;
            nameInputs[1].style.backgroundColor = color2;
            nameInputs[1].style.color = fontColor2;
        }

        historyListEl.innerHTML = "";
        if (gameState.gameHistory && gameState.gameHistory.length > 0) {
            gameState.gameHistory.forEach(game => {
                const div = document.createElement("div");
                div.textContent = `${game.p1} - ${game.p2}`;
                historyListEl.appendChild(div);
            });
        }
    }

    function resetGame() {
        const freshState = { scores: [0, 0], sets: [0, 0], server: 1, initialServer: 1, names: ["Игрок 1", "Игрок 2"], gameHistory: [], colorAssignment: "default" };
        stateRef.set(freshState);
    }

    function resetScore() {
        if (!gameState) return;
        gameState.scores = [0, 0];
        gameState.server = gameState.initialServer; // Подача возвращается к тому, кто начинал сет
        saveState();
    }

    stateRef.on("value", snapshot => {
        updateDisplay(snapshot.val());
    });

    document.addEventListener("DOMContentLoaded", loadPlayers);
</script>
</body>
</html>


